services:
  # =============================================================================
  # GATEWAY - External API Entry Point (Port 8000)
  # =============================================================================
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: aesthetiq-gateway
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # Override service URLs to point to internal Docker network
      - FACE_ANALYSIS_URL=http://face_analysis:8001
      - CLOTHING_RECOMMENDER_URL=http://conversational_agent:8002
      - EMBEDDING_SERVICE_URL=http://embedding_service:8004
    networks:
      - aesthetiq-network
    depends_on:
      face_analysis:
        condition: service_healthy
      conversational_agent:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # =============================================================================
  # FACE ANALYSIS - ML/CV Service (Port 8001 - Internal Only)
  # =============================================================================
  face_analysis:
    build:
      context: ./face_analysis
      dockerfile: Dockerfile
    container_name: aesthetiq-face-analysis
    # No external port exposure - internal only
    expose:
      - "8001"
    env_file:
      - .env
    environment:
      - PORT=8001
      - DEVICE=cpu
    volumes:
      # Mount weights directory for model files
      - ./weights:/app/weights:ro
      # Mount uploads directory if needed for image processing
      - ./uploads:/app/uploads:rw
    networks:
      - aesthetiq-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Longer start period for model loading (takes ~90s to initialize)
    restart: unless-stopped
    # Resource limits for ML service
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

  # =============================================================================
  # CONVERSATIONAL AGENT - Multi-Agent LLM Service (Port 8002 - Internal Only)
  # =============================================================================
  conversational_agent:
    build:
      context: ./conversational_agent
      dockerfile: Dockerfile
    container_name: aesthetiq-conversational-agent
    # No external port exposure - internal only
    expose:
      - "8002"
    env_file:
      - .env
    environment:
      - PORT=8002
      - BACKEND_URL=http://host.docker.internal:3001
      # Override MCP_SERVERS_URL to use Docker network hostname
      - MCP_SERVERS_URL=http://mcp_servers:8010
    volumes:
      # Mount logs directory for chat history
      - ./logs:/app/logs:rw
    networks:
      - aesthetiq-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mcp_servers:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # =============================================================================
  # EMBEDDING SERVICE - Multimodal CLIP Embeddings (Port 8004)
  # =============================================================================
  embedding_service:
    build:
      context: ./embedding_service
      dockerfile: Dockerfile
    container_name: aesthetiq-embedding
    # Expose port for local scripts (embed_commerce_items.py)
    ports:
      - "8004:8004"
    environment:
      - PORT=8004
      - LOG_LEVEL=INFO
    networks:
      - aesthetiq-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8004/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Model loading takes time
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
          # Uncomment for GPU support (requires nvidia-docker)
          # devices:
          #   - driver: nvidia
          #     count: 1
          #     capabilities: [gpu]

  # =============================================================================
  # MCP SERVERS - Unified MCP tool service (Port 8010 - Internal Only)
  # =============================================================================
  mcp_servers:
    build:
      context: ./mcp_servers
      dockerfile: Dockerfile
    container_name: aesthetiq-mcp-servers
    expose:
      - "8010"
    env_file:
      - .env
    environment:
      - PORT=8010
      - EMBEDDING_SERVICE_URL=http://embedding_service:8004
    networks:
      - aesthetiq-network
    depends_on:
      embedding_service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

networks:
  aesthetiq-network:
    driver: bridge
    name: aesthetiq-network

volumes:
  weights:
    driver: local
  uploads:
    driver: local
