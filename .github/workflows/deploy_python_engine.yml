name: Deploy Python Engine (Azure VM)

on:
  push:
    branches:
      - main
    paths:
      - "python_engine/**"
      - ".github/workflows/deploy_python_engine.yml"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Services
        id: changes
        run: |
          CHANGED_SERVICES=""
          for service in gateway conversational_agent embedding_service face_analysis try_on_service mcp_servers crawler_service; do
            if git diff HEAD~1 --quiet -- python_engine/$service/ 2>/dev/null; then
              echo "No changes in $service"
            else
              CHANGED_SERVICES="$CHANGED_SERVICES $service"
              echo "Changes detected in $service"
            fi
          done
          
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "services=[]" >> $GITHUB_OUTPUT
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            SERVICES_JSON=$(echo "$CHANGED_SERVICES" | jq -R 'split(" ") | map(select(length > 0))')
            echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT
            echo "Changed services: $CHANGED_SERVICES"
          fi

  build-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: aesthetiqregistry.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Create CI .env.prod
        working-directory: python_engine
        run: |
          cat > .env.prod <<'EOF'
          # CI placeholder file for docker compose
          EOF

      - name: Free Disk Space
        run: |
          df -h
          docker system prune -a --force
          docker volume prune -f
          df -h

      - name: Build and Push ${{ matrix.service }}
        working-directory: python_engine
        env:
          DOCKER_BUILDKIT: 1
        run: |
          echo "Building ${{ matrix.service }}..."
          docker compose -f docker-compose.prod.yml build \
            --build-arg BUILDKIT_INLINE_CACHE=1 ${{ matrix.service }}
          docker compose -f docker-compose.prod.yml push ${{ matrix.service }}

  deploy:
    needs: build-service
    if: always() && !failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VM_SSH_KEY }}

      - name: Copy docker-compose to VM
        run: |
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          scp -o StrictHostKeyChecking=no \
            python_engine/docker-compose.prod.yml \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:/srv/aesthetiq/project/

      - name: Deploy on VM
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'DEPLOY'
          set -e
          cd /srv/aesthetiq/project
          
          # Clean up old Docker images and containers
          echo "Cleaning up Docker resources..."
          docker system prune -a -f
          docker volume prune -f
          df -h
          
          # Pull new images
          docker compose -f docker-compose.prod.yml pull
          
          # Restart services
          docker compose -f docker-compose.prod.yml up -d --force-recreate
          docker compose -f docker-compose.prod.yml ps
          DEPLOY
